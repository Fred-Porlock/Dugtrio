import base64


# base64url解码，并转换为字符串
def base64url_decode(str):
    # 补充base64末尾的=
    str += '=' * (-len(str) % 4)
    # base64url解码
    str = base64.urlsafe_b64decode(str)
    # 转换为字符串
    str = str.decode('utf-8')
    return str

# claimName包含引号
def claimOperations(payload, claimName, offset = 0):
    # claim起始位置
    claim_index = payload.index(claimName)
    # claim的结束位置
    claim_value_index_payload = payload.index('"', claim_index + len(claimName))
    quote_index = payload.index('"', claim_value_index_payload + 1)
    comma_index = payload.index(',', claim_value_index_payload + 1)
    # 截取claim，包括claimName和claimValue和逗号
    claim = payload[claim_index : comma_index + 1]
    length = len(claim)
    # 冒号的下标
    colon_index = claim.index(':')
    # claimValue的起始位置
    claim_value_index = claim.index('"', colon_index + 1)
    # 截取claimValue
    claim_value = payload[claim_value_index_payload : quote_index + 1]
    # claimValue的长度
    claim_value_length = len(claim_value)

    # 根据claim起始位置计算base64编码后的payload中的起始位置
    claim_index_b64 = (claim_index // 3) * 4 + offset
    # 根据claim结束位置计算base64编码后的payload中的结束位置
    claim_end_index_b64 = ((quote_index+1) // 3) * 4 + 4 + offset
    # base64编码后的claim的长度
    length_b64 = claim_end_index_b64 - claim_index_b64

    return (claim, length, claim_index_b64, length_b64, colon_index, claim_value_index, claim_value_length, claim_value)

# "I don't understand you... *sigh*..."
# claimName包含引号
def newClaimOperations(payload, claimName, offset = 0):
    # claim起始位置
    claim_start_index = payload.index(claimName)
    # claim的结束位置
    claim_value_start_index = payload.index('"', claim_start_index + len(claimName))
    claim_end_index = payload.index(',', claim_value_start_index + 1)
    # 截取claim，包括claimName和claimValue和逗号
    claim = payload[claim_start_index : claim_end_index + 1]
    length = len(claim)
    # 冒号的下标
    claim_colon_index = claim.index(':')
    # claimValue的起始位置
    claim_value_index = claim.index('"', claim_colon_index + 1)
    # 截取claimValue
    claim_value = claim[claim_value_index : claim_end_index + 1]
    # claimValue的长度
    claim_value_length = len(claim_value)

    # 根据claim起始位置计算base64编码后的payload中的起始位置
    claim_start_index_b64 = (claim_start_index // 3) * 4 + offset
    # 根据claim结束位置计算base64编码后的payload中的结束位置
    claim_end_index_b64 = (claim_end_index // 3) * 4 + 4 + offset
    # base64编码后的claim的长度
    length_b64 = claim_end_index_b64 - claim_start_index_b64

    return (claim, length, claim_start_index_b64, length_b64, claim_colon_index, claim_value_index, claim_value_length, claim_value)

unsigned_jwt = [
    "101", "121", "74", "104", "98", "71", "99", "105", "79", "105", "74", "83", "85", "122", "73", "49", "78", "105", "73", "115", "73", "109", "116", "112", "90", "67", "73", "54", "73", "109", "77", "53", "89", "87", "90", "107", "89", "84", "77", "50", "79", "68", "74", "108", "89", "109", "89", "119", "79", "87", "86", "105", "77", "122", "65", "49", "78", "87", "77", "120", "89", "122", "82", "105", "90", "68", "77", "53", "89", "106", "99", "49", "77", "87", "90", "105", "90", "106", "103", "120", "79", "84", "85", "105", "76", "67", "74", "48", "101", "88", "65", "105", "79", "105", "74", "75", "86", "49", "81", "105", "102", "81", "46", "101", "121", "74", "112", "99", "51", "77", "105", "79", "105", "74", "111", "100", "72", "82", "119", "99", "122", "111", "118", "76", "50", "70", "106", "89", "50", "57", "49", "98", "110", "82", "122", "76", "109", "100", "118", "98", "50", "100", "115", "90", "83", "53", "106", "98", "50", "48", "105", "76", "67", "74", "104", "101", "110", "65", "105", "79", "105", "73", "53", "78", "68", "89", "51", "77", "122", "69", "122", "78", "84", "73", "121", "78", "122", "89", "116", "99", "71", "115", "49", "90", "50", "120", "106", "90", "122", "104", "106", "99", "87", "56", "122", "79", "71", "53", "107", "89", "106", "77", "53", "97", "68", "100", "113", "77", "68", "107", "122", "90", "110", "66", "122", "99", "71", "104", "49", "99", "51", "85", "117", "89", "88", "66", "119", "99", "121", "53", "110", "98", "50", "57", "110", "98", "71", "86", "49", "99", "50", "86", "121", "89", "50", "57", "117", "100", "71", "86", "117", "100", "67", "53", "106", "98", "50", "48", "105", "76", "67", "74", "104", "100", "87", "81", "105", "79", "105", "73", "53", "78", "68", "89", "51", "77", "122", "69", "122", "78", "84", "73", "121", "78", "122", "89", "116", "99", "71", "115", "49", "90", "50", "120", "106", "90", "122", "104", "106", "99", "87", "56", "122", "79", "71", "53", "107", "89", "106", "77", "53", "97", "68", "100", "113", "77", "68", "107", "122", "90", "110", "66", "122", "99", "71", "104", "49", "99", "51", "85", "117", "89", "88", "66", "119", "99", "121", "53", "110", "98", "50", "57", "110", "98", "71", "86", "49", "99", "50", "86", "121", "89", "50", "57", "117", "100", "71", "86", "117", "100", "67", "53", "106", "98", "50", "48", "105", "76", "67", "74", "122", "100", "87", "73", "105", "79", "105", "73", "120", "77", "84", "69", "119", "79", "84", "89", "122", "79", "68", "103", "121", "77", "106", "81", "50", "78", "84", "73", "121", "79", "68", "85", "49", "78", "106", "81", "105", "76", "67", "74", "111", "90", "67", "73", "54", "73", "109", "49", "53", "99", "51", "82", "108", "98", "109", "120", "104", "89", "110", "77", "117", "89", "50", "57", "116", "73", "105", "119", "105", "90", "87", "49", "104", "97", "87", "119", "105", "79", "105", "74", "48", "90", "88", "78", "48", "90", "87", "49", "104", "97", "87", "120", "104", "90", "71", "82", "121", "90", "88", "78", "122", "81", "71", "49", "53", "99", "51", "82", "108", "98", "109", "120", "104", "89", "110", "77", "117", "89", "50", "57", "116", "73", "105", "119", "105", "90", "87", "49", "104", "97", "87", "120", "102", "100", "109", "86", "121", "97", "87", "90", "112", "90", "87", "81", "105", "79", "110", "82", "121", "100", "87", "85", "115", "73", "109", "53", "118", "98", "109", "78", "108", "73", "106", "111", "105", "78", "121", "49", "87", "86", "84", "108", "109", "100", "86", "100", "108", "86", "51", "82", "110", "82", "69", "120", "73", "98", "86", "90", "75", "77", "108", "86", "48", "85", "110", "74", "112", "98", "109", "85", "52", "73", "105", "119", "105", "98", "109", "74", "109", "73", "106", "111", "120", "78", "106", "107", "121", "79", "84", "65", "53", "77", "84", "73", "121", "76", "67", "74", "117", "89", "87", "49", "108", "73", "106", "111", "105", "81", "87", "120", "112", "89", "50", "85", "103", "81", "109", "57", "105", "73", "105", "119", "105", "99", "71", "108", "106", "100", "72", "86", "121", "90", "83", "73", "54", "73", "109", "104", "48", "100", "72", "66", "122", "79", "105", "56", "118", "98", "71", "103", "122", "76", "109", "100", "118", "98", "50", "100", "115", "90", "88", "86", "122", "90", "88", "74", "106", "98", "50", "53", "48", "90", "87", "53", "48", "76", "109", "78", "118", "98", "83", "57", "104", "76", "48", "70", "66", "89", "48", "104", "85", "100", "71", "86", "102", "86", "87", "70", "51", "86", "71", "82", "75", "81", "122", "90", "89", "78", "106", "85", "120", "83", "87", "120", "106", "82", "110", "104", "88", "90", "68", "90", "109", "99", "107", "78", "77", "85", "87", "49", "70", "87", "71", "53", "85", "77", "86", "112", "53", "86", "69", "49", "50", "82", "72", "74", "50", "98", "122", "49", "122", "79", "84", "89", "116", "89", "121", "73", "115", "73", "109", "100", "112", "100", "109", "86", "117", "88", "50", "53", "104", "98", "87", "85", "105", "79", "105", "74", "66", "98", "71", "108", "106", "90", "83", "73", "115", "73", "109", "90", "104", "98", "87", "108", "115", "101", "86", "57", "117", "89", "87", "49", "108", "73", "106", "111", "105", "81", "109", "57", "105", "73", "105", "119", "105", "98", "71", "57", "106", "89", "87", "120", "108", "73", "106", "111", "105", "90", "87", "52", "105", "76", "67", "74", "112", "89", "88", "81", "105", "79", "106", "69", "50", "79", "84", "73", "53", "77", "68", "107", "48", "77", "106", "73", "115", "73", "109", "86", "52", "99", "67", "73", "54", "77", "84", "89", "53", "77", "106", "107", "120", "77", "122", "65", "121", "77", "105", "119", "105", "97", "110", "82", "112", "73", "106", "111", "105", "90", "106", "81", "49", "77", "84", "69", "52", "77", "87", "81", "48", "78", "106", "82", "106", "78", "106", "73", "120", "90", "87", "74", "104", "77", "84", "85", "120", "89", "106", "70", "104", "89", "50", "69", "51", "90", "109", "73", "51", "77", "109", "73", "49", "77", "87", "86", "108", "78", "109", "73", "122", "89", "105", "74", "57"
]

# 把unsigned_jwt转换为字符串
jwt = ''.join(chr(int(x)) for x in unsigned_jwt)

# jwt的第一个点的下标
first_dot_index = jwt.index('.')

# 截取payload
payload = jwt.split('.')[1]
# base64url解码
payload = base64url_decode(payload)
print(f"Decoded payload: {payload}")

# 处理aud
(aud, aud_length, aud_index_b64, aud_length_b64, aud_colon_index, aud_value_index, aud_value_length, aud_value) = claimOperations(payload, '"aud"', offset = first_dot_index + 1)
# 全部print
print(f"aud: {aud}")
print(f"aud_length: {aud_length}")
print(f"aud_index_b64: {aud_index_b64}")
print(f"aud_length_b64: {aud_length_b64}")
print(f"aud_colon_index: {aud_colon_index}")
print(f"aud_value_index: {aud_value_index}")
print(f"aud_value_length: {aud_value_length}")
print(f"aud_value: {aud_value}")

test = jwt[aud_index_b64 : aud_index_b64 + aud_length_b64 -4]
print(base64url_decode(test))

# ext_aud = [34, 97, 117, 100, 34, 58, 34, 57, 52, 54, 55, 51, 49, 51, 53, 50, 50, 55, 54, 45, 112, 107, 53, 103, 108, 99, 103, 56, 99, 113, 111, 51, 56, 110, 100, 98, 51, 57, 104, 55, 106, 48, 57, 51, 102, 112, 115, 112, 104, 117, 115, 117, 46, 97, 112, 112, 115, 46, 103, 111, 111, 103, 108, 101, 117, 115, 101, 114, 99, 111, 110, 116, 101, 110, 116, 46, 99, 111, 109, 34, 44]
# # 把ext_aud转换为字符串
# ext_aud_str = ''.join(chr(x) for x in ext_aud)
# print(f"ext_aud_str: {ext_aud_str}")